---
description: 
globs: 
alwaysApply: true
---
# 📘 Business Rule 생성 규칙 문서 (AI Context용)

## 1. 목적
업무 정의서(자연어 기반)로부터 반복적으로 등장하는 조건, 전제, 상태 변경, 예외 처리를 구조화하여 추출하고,
Service, Orchestrator에서 재사용 가능한 **비즈니스 로직 규칙(Business Rules)**으로 정리한다.

이 규칙은 사람이 설계하거나, AI가 자연어 업무 정의로부터 자동 추출하며,
하드코딩이 아닌 호출 또는 삽입 방식으로 적용된다.

---

## 2. 구성 항목 (자연어 서술 기반 정의)

- **규칙 ID**: vip_auto_approve  
  > 규칙을 대표하는 고유한 키워드 (알파벳/스네이크케이스)

- **규칙 이름**: VIP 고객 자동 승인  
  > 사람이 알아보기 쉽게 지정한 명칭

- **대상 업무(엔티티)**: 주문 생성(Order Creation)  
  > 규칙이 작동하는 대상 또는 업무 흐름

- **조건 설명**:  
  > 고객 등급이 ‘VIP’일 경우 주문 상태를 자동으로 '승인'으로 설정한다.

- **조건 항목**:  
  > 고객의 grade 값이 'VIP'일 때

- **실행 동작**:  
  > 주문의 status 필드를 'approved'로 설정한다

- **오류 발생 여부**: 없음  
  > 이 규칙은 조건에 따라 값을 설정하는 로직이며, 예외를 발생시키지 않는다

- **적용 위치**: 서비스 내부  
  > Orchestrator나 Service 내부에서 `RuleExecutor`를 통해 호출된다

- **중요도**: 높음 (critical)

- **관련 태그**: 주문, 승인, VIP

- **사용 예시**:  
  > 고객이 주문을 생성할 때 고객 등급이 VIP라면, 주문 상태는 자동으로 '승인됨' 상태가 된다

---

## 3. 규칙 추출 키워드 (자연어 업무 정의서 기반)

- **조건 유도 키워드**:
  - “~인 경우”, “~일 때”, “~이상일 경우”, “~가 없으면”, “~이면 실패”

- **상태 설정 키워드**:
  - “~로 설정한다”, “~로 변경된다”, “자동으로 ~ 된다”, “초기값은 ~”
- **예외 및 경고 유도 표현**:
  - “오류를 반환한다”, “예외가 발생한다”, “수정할 수 없다”, “차단된다”

---

## 4. 예시 규칙 (자연어 서술 기반)

### ✅ VIP 고객 자동 승인
- 규칙 ID: vip_auto_approve
- 설명: 고객 등급이 VIP일 경우, 주문 생성 시 자동으로 상태를 approved로 설정한다
- 조건: user.grade == 'VIP'
- 동작: order.status = 'approved'
- 위치: OrderService@placeOrder 내부
- 중요도: 높음

### ✅ 재고 부족 시 오류 반환
- 규칙 ID: stock_check_required
- 설명: 상품의 재고가 0 이하일 경우 주문을 차단하고 오류를 반환한다
- 조건: product.stock <= 0
- 동작: 오류 발생, 메시지: “재고가 부족합니다.”
- 위치: OrderService 또는 ProductService 내부

### ✅ 승인 이후 수정 금지
- 규칙 ID: lock_after_approval
- 설명: 상태가 approved인 데이터는 수정할 수 없다
- 조건: entity.status == 'approved'
- 동작: 예외 발생, 메시지: “승인된 항목은 수정할 수 없습니다.”
- 위치: 모든 update 메서드 전 조건 검증 시

---

## 5. 적용 방식 요약

- AI 또는 사람이 위와 같은 규칙을 정의하거나 추출함
- 서비스 또는 오케스트레이터 내부에서 다음처럼 적용함:

```php
$this->ruleExecutor->execute([
    'vip_auto_approve',
    'stock_check_required'
], $target);
```

- 규칙 정의는 데이터베이스, JSON, PHP Class 등으로 관리될 수 있으며
  자동 생성을 위해 사람이 작성한 문장은 위 규칙 포맷으로 정리되어야 함

---

## 6. 기대 효과
- 업무 정의에서 규칙을 자동 추출할 수 있음
- 중복되는 조건 로직을 코드로 복붙하지 않고 호출 구조로 일원화
- 규칙 변경 시 단일 위치에서 유지보수 가능
- 규칙 목록을 정량화하여 통제 가능한 업무 정책 레이어 생성
